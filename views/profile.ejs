<%- include('layouts/innerheader'); -%>
<style>
nav {
    position: static;
	}
    .close {
  cursor: pointer;
  position: absolute;
  top: 50%;
  right: 0%;
  padding: 12px 16px;
  transform: translate(0%, -50%);
}
.btn_wid_shanal input{
width:60% !important;}
.close:hover {background: #bbb;}
</style>
<body>
<div class="flex_div_bread">
    <div class="pdhs">
       <svg class="svgt" _ngcontent-ng-c3832377555="" width="17" height="17" viewBox="0 0 17 17" fill="none" xmlns="http://www.w3.org/2000/svg"><path _ngcontent-ng-c3832377555="" d="M1.42393 16H15.5759C15.6884 16 15.7962 15.9584 15.8758 15.8844C15.9553 15.8104 16 15.71 16 15.6054V6.29143C16 6.22989 15.9846 6.1692 15.9549 6.11422C15.9252 6.05923 15.8821 6.01147 15.829 5.97475L8.75305 1.07803C8.67992 1.02736 8.59118 1 8.5 1C8.40882 1 8.32008 1.02736 8.24695 1.07803L1.17098 5.97587C1.11791 6.01259 1.0748 6.06035 1.04511 6.11534C1.01543 6.17033 0.999976 6.23101 1 6.29255V15.6063C1.00027 15.7108 1.04504 15.8109 1.12451 15.8847C1.20398 15.9585 1.31165 16 1.42393 16ZM10.1464 15.2107H6.85241V10.6202H10.1464V15.2107ZM1.84866 6.48977L8.4999 1.88561L15.1517 6.48977V15.2107H10.9946V10.2256C10.9946 10.1209 10.95 10.0206 10.8704 9.94654C10.7909 9.87254 10.683 9.83096 10.5705 9.83096H6.42848C6.316 9.83096 6.20812 9.87254 6.12858 9.94654C6.04904 10.0206 6.00435 10.1209 6.00435 10.2256V15.2107H1.84806L1.84866 6.48977Z" fill="#55585B" stroke="#55585B" stroke-width="0.5"></path></svg> <span class="hme"><a href="/welcome">Home</a></span><span class="bread_div">/</span><span class="hme">Edit Profile</span>
    </div>
	
</div>
    <div class="container-xl px-4 mt-4">
         
        <form method="post" action="/update-profile" id="submitFormValidate" enctype="multipart/form-data">
            <div class="">
                <% if (errors.length > 0) { %>
                    <div class="alert alert-danger alert-dismissible">
                        <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                        <%= errors[0] %>
                        </div>
                    </div>
                <% } %>
                <% if (success.length > 0) { %>
                    <div class="alert alert-success alert-dismissible">
                        <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                        <%= success[0] %>
                        </div>
                    </div>
                <% } %>
        <div class="row">
            <div class="col-xl-4">
                <!-- Profile picture card-->
                <div class="card mb-4 mb-xl-0">
                    <div class="card-header">Profile Picture</div>
                    <div class="card-body text-center">
                        <!-- Profile picture image-->
                        <% if (user[0].user.profile_image) { %>
                            <img class="img-account-profile rounded-circle mb-2" id="profile_image" src="<%= user[0].user.profile_image %>" alt="" style="
                            height: 148px;
                        "><span class="close" onclick = "removeProfilePic(event)">&times;</span>
                        <% } else {%>
                            <img class="img-account-profile rounded-circle mb-2" src="/images/dummy.png" alt="" style="
                            height: 148px;
                        ">
                        <% } %>
                        <!-- Profile picture help block-->
                        <div class="small font-italic text-muted mb-4">JPG, JPEG or PNG no larger than 5 MB</div>
                        <!-- Profile picture upload button-->
                        
                        <!-- <input class="btn btn-primary inputError" type="file" name ="profile_image" multiple="multiple" accept="image/*" id="imageId" onchange="return validateFileUpload()"> -->
                        <input class="btn btn-primary" type="file" name ="profile_image" multiple="multiple" accept="image/*" id="imageId" onchange="return validateFileUpload()">
                        
                        <input  type="hidden" name = "profile_image_exist" id = "profile_image_exist" value = "<%= user[0].user.profile_image %>">
                        <!-- <span role="alert" class="requiredError" aria-hidden="true">
                            Please upload Profile Picture
                        </span> -->
                    </div>
                </div>

                <div class="card mb-4 mb-xl-0">
                    <div class="card-header"></div>
                    <div class="card-body text-center">
                        <!-- Profile picture image-->
                        
                        <a class="btn btn-primary" href="/winning-bid" role="button">Won Bids</a>
                    </div>
                </div>
            </div>
            <div class="col-xl-8">
                <!-- Account details card-->
                <div class="card mb-4">
                    <div class="card-header">Account Details</div>
                    <div class="card-body">
                        <form>
                            <!-- Form Group (username)-->
                            <div class="mb-3">
                                <label class="small mb-1" for="inputUsername">Username (how your name will appear to other users on the site)</label>
                                <input id="name" placeholder="Name" type="text" name="name" class="inputError"
                                value="<%= typeof user[0].user.name !== 'undefined' ?  user[0].user.name : '' %>">
                                <span role="alert" class="requiredError" aria-hidden="true">
                                    Please enter Name
                                </span>
                            </div>
                            
                            <!-- Form Row-->
                            
                            <!-- Form Group (email address)-->
                            <div class="mb-3">
                                <label class="small mb-1" for="inputEmailAddress">Email address</label>
                                <input id="email" placeholder="Email" class="inputError emailInput" type="email" name="email"
                        value="<%= typeof user[0].user.email !== 'undefined' ?  user[0].user.email : '' %>">
                        <span role="alert" class="requiredError" aria-hidden="true">
                            Please enter Email
                          </span>
                    </div>
                    
                            <!-- Form Row-->
                            <div class="row gx-3 mb-3">
                                <!-- Form Group (phone number)-->
                                <div class="col-md-12">
                                    <label class="small mb-1" for="inputPhone">About</label>
                                    <textarea id="about-field" placeholder="About" type="text" name="about" class="inputError"
                                    value="<%= typeof user[0].user.about !== 'undefined' ?  user[0].user.about : '' %>"><%= typeof user[0].user.about !== 'undefined' ?  user[0].user.about : '' %></textarea>
                                    <span role="alert" class="requiredError" aria-hidden="true">
                                        Please enter About
                                      </span>
                                </div>
                                
                                <!-- Form Group (birthday)-->
                               
                            </div>
                            <!-- Save changes button-->
							<div class="btn_wid_shanal text-center">
                            <input type="submit" value="Update" class="login-btn" onclick="validateForm(event)">
							</div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </form>
    </div>
  </body>
  <script>

    // function removeProfilePic(){
    //     document.getElementById('profile_image').src = '';
    //     document.getElementById('profile_image_exist') = '';
    //     document.getElementById('imageId') = '';
    // }
    function removeProfilePic(e) {
        e.preventDefault(); // avoid to execute the actual submit of the form.
            $.ajax({
                type: "POST",
                url: 'http://localhost:8081/remove-profile-image',
                data : {
                    
                },
                success: function(data)
                {
                    window.location.assign('/profile');
                    // document.getElementById('profile_image').src = '';
                    // document.getElementById('profile_image_exist') = '';
                    // document.getElementById('imageId') = '';
                }
            });
    }
    
    function validateFileUpload() {
        var fuData = document.getElementById('imageId');
        var FileUploadPath = fuData.value;
        const userNameField = document.getElementsByClassName("inputError");
        // if (FileUploadPath == '') {
        //     // alert("Please upload an image");
        if (FileUploadPath){
            var Extension = FileUploadPath.substring(
            FileUploadPath.lastIndexOf('.') + 1).toLowerCase();
            if (Extension == "png" || Extension == "jpg" || Extension == "jpeg") {
                const fsize = fuData.files.item(0).size;
                const file = Math.round((fsize / 1024));
                // The size of the file.
                if (file >= 5120) {
                    document.getElementById('imageId').value = '';
                    document.getElementsByClassName("requiredError")[0].textContent = "File too Big, please select a file less than 5mb";
                    const showlengthErr = document.getElementsByClassName("requiredError");
                    showlengthErr[0].classList.add("visible");
                    userNameField[0].classList.add("invalid");
                    showlengthErr[0].setAttribute("aria-hidden", false);
                    showlengthErr[0].setAttribute("aria-invalid", true);
                    // alert(
                    // "File too Big, please select a file less than 5mb");
                } else{
                    const showRequiredErr = document.getElementsByClassName("requiredError");
                    showRequiredErr[0].classList.remove("visible");
                    userNameField[0].classList.remove("invalid");
                    showRequiredErr[0].setAttribute("aria-hidden", true);
                    showRequiredErr[0].setAttribute("aria-invalid", false);
                }
                // else if (file < 2048) {
                //     alert(
                //     "File too small, please select a file greater than 2mb");
                // } else {
                //     document.getElementById('size').innerHTML = '<b>'
                //     + file + '</b> KB';
                // }
                    
                // if (fuData.files && fuData.files[0]) {
                //     var reader = new FileReader();

                //     reader.onload = function(e) {
                //         $('#blah').attr('src', e.target.result);
                //     }

                //     reader.readAsDataURL(fuData.files[0]);
                // }

            } else {
                document.getElementById('imageId').value = '';
                document.getElementsByClassName("requiredError")[0].textContent = "Photo only allows file types of PNG, JPG or JPEG.";
                const showlengthErr = document.getElementsByClassName("requiredError");
                showlengthErr[0].classList.add("visible");
                userNameField[0].classList.add("invalid");
                showlengthErr[0].setAttribute("aria-hidden", false);
                showlengthErr[0].setAttribute("aria-invalid", true);
                // alert("Photo only allows file types of GIF, PNG, JPG, JPEG and BMP. ");
            }
        }
    }
    function validateForm(e) {
        const form = document.getElementById('submitFormValidate')
        e.preventDefault();
        const userNameField = document.getElementsByClassName("inputError");
        var is_profile_image_exist = false;
        let vaClass = true;
        for (var i = 0; i < userNameField.length; i++) {
            const profile_image_exist = document.getElementById("profile_image_exist").value;
            console.log(profile_image_exist,'profile_image_exist')
            is_profile_image_exist = profile_image_exist ? true : false;
            // if(i == 0 && !userNameField[i].value && !is_profile_image_exist){
            if(i == 0 && !userNameField[i].value){
                console.log('gfdgdf')
                vaClass = false;
                const showRequiredErr = document.getElementsByClassName("requiredError");
                showRequiredErr[i].classList.add("visible");
                userNameField[i].classList.add("invalid");
                showRequiredErr[i].setAttribute("aria-hidden", false);
                showRequiredErr[i].setAttribute("aria-invalid", true);
            }else if (!userNameField[i].value && i != 0) {
                vaClass = false;
                const showRequiredErr = document.getElementsByClassName("requiredError");
                showRequiredErr[i].classList.add("visible");
                userNameField[i].classList.add("invalid");
                showRequiredErr[i].setAttribute("aria-hidden", false);
                showRequiredErr[i].setAttribute("aria-invalid", true);
            }else{
                const showRequiredErr = document.getElementsByClassName("requiredError");
                showRequiredErr[i].classList.remove("visible");
                userNameField[i].classList.remove("invalid");
                showRequiredErr[i].setAttribute("aria-hidden", true);
                showRequiredErr[i].setAttribute("aria-invalid", false);
                if(userNameField[i].value.length > 30 && i == 1){
                    vaClass = false;
                    document.getElementsByClassName("requiredError")[i].textContent = "Maximum 30 characters are allowed";
                    const showlengthErr = document.getElementsByClassName("requiredError");
                    showlengthErr[i].classList.add("visible");
                    userNameField[i].classList.add("invalid");
                    showlengthErr[i].setAttribute("aria-hidden", false);
                    showlengthErr[i].setAttribute("aria-invalid", true);
                  }else{
                    if(i == 2){
                        let userEmail = document.getElementsByClassName('emailInput')[0].value;
                        let regex = new RegExp(/\S+@\S+\.\S+/);
                        let isValid = regex.test(userEmail);
                        if (isValid) {
                          const showlengthErr = document.getElementsByClassName("requiredError");
                          showlengthErr[i].classList.remove("visible");
                          userNameField[i].classList.remove("invalid");
                          showlengthErr[i].setAttribute("aria-hidden", true);
                          showlengthErr[i].setAttribute("aria-invalid", false);
                        } else {
                            vaClass = false;
                            document.getElementsByClassName("requiredError")[i].textContent =  "Email is not a valid email address";
                            const showlengthErr = document.getElementsByClassName("requiredError");
                            showlengthErr[i].classList.add("visible");
                            userNameField[i].classList.add("invalid");
                            showlengthErr[i].setAttribute("aria-hidden", false);
                            showlengthErr[i].setAttribute("aria-invalid", true);
                        }
                    }else{
                      const showlengthErr = document.getElementsByClassName("requiredError");
                      showlengthErr[i].classList.remove("visible");
                      userNameField[i].classList.remove("invalid");
                      showlengthErr[i].setAttribute("aria-hidden", true);
                      showlengthErr[i].setAttribute("aria-invalid", false);
                    }
                }
            }
        }
        if(vaClass){
            form.submit();
        }else{
            return false;
        }
    }
    </script>
  <%- include('layouts/footer'); -%>